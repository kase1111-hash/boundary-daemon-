#!/usr/bin/env bash
#
# Pre-commit hook for Boundary Daemon
# Detects hardcoded credentials and secrets before they are committed
#
# Install: git config core.hooksPath .githooks
# Or run: ./scripts/install-hooks.sh
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

# Configuration
EXCLUDE_DIRS="\.git|node_modules|__pycache__|\.pytest_cache|\.venv|venv|\.egg-info"
EXCLUDE_FILES="\.pyc$|\.pyo$|\.so$|\.dylib$|\.dll$|\.exe$"

# Files being committed
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py|js|ts|json|yaml|yml|toml|ini|cfg|conf|sh|bash|env|txt|md)$' || true)

if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${GREEN}[pre-commit]${NC} Scanning for hardcoded credentials..."

FOUND_SECRETS=0
WARNINGS=0

# Function to check a pattern and report findings
check_pattern() {
    local pattern="$1"
    local description="$2"
    local severity="$3"  # ERROR or WARNING

    for file in $STAGED_FILES; do
        # Skip excluded directories
        if echo "$file" | grep -qE "$EXCLUDE_DIRS"; then
            continue
        fi

        # Skip test files for some patterns (allow test tokens)
        if [[ "$severity" == "WARNING" ]] && echo "$file" | grep -qE "^tests?/|_test\.py$|test_.*\.py$"; then
            continue
        fi

        # Search for pattern in staged content
        matches=$(git diff --cached "$file" | grep -n "^+" | grep -iE "$pattern" || true)

        if [ -n "$matches" ]; then
            if [ "$severity" == "ERROR" ]; then
                echo -e "${RED}[ERROR]${NC} $description in $file:"
                echo "$matches" | head -5
                FOUND_SECRETS=1
            else
                echo -e "${YELLOW}[WARNING]${NC} $description in $file:"
                echo "$matches" | head -3
                WARNINGS=$((WARNINGS + 1))
            fi
        fi
    done
}

# =============================================================================
# HIGH SEVERITY - Block commit
# =============================================================================

# AWS Access Keys
check_pattern "AKIA[0-9A-Z]{16}" "AWS Access Key ID detected" "ERROR"

# AWS Secret Keys (40 char base64)
check_pattern "['\"][A-Za-z0-9/+=]{40}['\"]" "Potential AWS Secret Key" "WARNING"

# GCP Service Account Keys
check_pattern '"type":\s*"service_account"' "GCP Service Account JSON detected" "ERROR"
check_pattern '"private_key":\s*"-----BEGIN' "GCP Private Key detected" "ERROR"

# Azure Keys
check_pattern "AccountKey=[A-Za-z0-9+/=]{88}" "Azure Storage Account Key detected" "ERROR"

# Generic Private Keys
check_pattern "-----BEGIN (RSA|DSA|EC|OPENSSH|PGP) PRIVATE KEY-----" "Private key detected" "ERROR"
check_pattern "-----BEGIN PRIVATE KEY-----" "Private key detected" "ERROR"
check_pattern "-----BEGIN ENCRYPTED PRIVATE KEY-----" "Encrypted private key detected" "WARNING"

# GitHub/GitLab Tokens
check_pattern "ghp_[a-zA-Z0-9]{36}" "GitHub Personal Access Token detected" "ERROR"
check_pattern "gho_[a-zA-Z0-9]{36}" "GitHub OAuth Token detected" "ERROR"
check_pattern "ghu_[a-zA-Z0-9]{36}" "GitHub User Token detected" "ERROR"
check_pattern "ghs_[a-zA-Z0-9]{36}" "GitHub Server Token detected" "ERROR"
check_pattern "glpat-[a-zA-Z0-9\-]{20}" "GitLab Personal Access Token detected" "ERROR"

# Slack Tokens
check_pattern "xox[baprs]-[0-9]{10,13}-[0-9]{10,13}-[a-zA-Z0-9]{24}" "Slack Token detected" "ERROR"

# Stripe Keys
check_pattern "sk_live_[0-9a-zA-Z]{24}" "Stripe Live Secret Key detected" "ERROR"
check_pattern "rk_live_[0-9a-zA-Z]{24}" "Stripe Live Restricted Key detected" "ERROR"

# SendGrid API Key
check_pattern "SG\.[a-zA-Z0-9]{22}\.[a-zA-Z0-9]{43}" "SendGrid API Key detected" "ERROR"

# Twilio
check_pattern "SK[a-f0-9]{32}" "Twilio API Key detected" "ERROR"

# JWT Secrets (common patterns)
check_pattern "jwt[_-]?secret['\"]?\s*[:=]\s*['\"][^'\"]{8,}" "JWT Secret detected" "ERROR"

# Database Connection Strings with passwords
check_pattern "postgres://[^:]+:[^@]+@" "PostgreSQL connection string with password" "ERROR"
check_pattern "mysql://[^:]+:[^@]+@" "MySQL connection string with password" "ERROR"
check_pattern "mongodb://[^:]+:[^@]+@" "MongoDB connection string with password" "ERROR"
check_pattern "redis://:[^@]+@" "Redis connection string with password" "ERROR"

# =============================================================================
# MEDIUM SEVERITY - Warning only (may have legitimate uses)
# =============================================================================

# Generic password patterns (not in test files)
check_pattern "password\s*[:=]\s*['\"][^'\"]{4,}['\"]" "Hardcoded password detected" "WARNING"
check_pattern "passwd\s*[:=]\s*['\"][^'\"]{4,}['\"]" "Hardcoded password detected" "WARNING"
check_pattern "secret\s*[:=]\s*['\"][^'\"]{8,}['\"]" "Hardcoded secret detected" "WARNING"

# API Keys (generic)
check_pattern "api[_-]?key\s*[:=]\s*['\"][a-zA-Z0-9]{16,}['\"]" "Potential API key detected" "WARNING"
check_pattern "apikey\s*[:=]\s*['\"][a-zA-Z0-9]{16,}['\"]" "Potential API key detected" "WARNING"

# Bearer tokens
check_pattern "Bearer\s+[a-zA-Z0-9_\-\.]+\.[a-zA-Z0-9_\-\.]+\.[a-zA-Z0-9_\-\.]+" "Bearer token (JWT) detected" "WARNING"

# =============================================================================
# Check for .env files (should never be committed)
# =============================================================================

ENV_FILES=$(echo "$STAGED_FILES" | grep -E "^\.env$|\.env\.local$|\.env\.prod|\.env\.production" || true)
if [ -n "$ENV_FILES" ]; then
    echo -e "${RED}[ERROR]${NC} Environment files should not be committed:"
    echo "$ENV_FILES"
    FOUND_SECRETS=1
fi

# =============================================================================
# Check for credential files
# =============================================================================

CRED_FILES=$(echo "$STAGED_FILES" | grep -E "credentials\.json$|service[_-]account\.json$|\.pem$|\.key$|id_rsa$|id_dsa$|id_ed25519$" || true)
if [ -n "$CRED_FILES" ]; then
    echo -e "${RED}[ERROR]${NC} Credential files should not be committed:"
    echo "$CRED_FILES"
    FOUND_SECRETS=1
fi

# =============================================================================
# Summary
# =============================================================================

echo ""
if [ $FOUND_SECRETS -eq 1 ]; then
    echo -e "${RED}========================================${NC}"
    echo -e "${RED}COMMIT BLOCKED: Secrets detected!${NC}"
    echo -e "${RED}========================================${NC}"
    echo ""
    echo "Please remove the detected secrets before committing."
    echo "If these are false positives, you can:"
    echo "  1. Add patterns to .gitignore"
    echo "  2. Use environment variables instead"
    echo "  3. Skip this check with: git commit --no-verify (NOT RECOMMENDED)"
    echo ""
    exit 1
elif [ $WARNINGS -gt 0 ]; then
    echo -e "${YELLOW}========================================${NC}"
    echo -e "${YELLOW}WARNING: $WARNINGS potential issues found${NC}"
    echo -e "${YELLOW}========================================${NC}"
    echo "Review the warnings above. Commit will proceed."
    echo ""
fi

echo -e "${GREEN}[pre-commit]${NC} Credential scan complete."
exit 0
